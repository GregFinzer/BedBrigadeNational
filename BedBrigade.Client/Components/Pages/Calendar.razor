@page "/calendar"
@page "/{LocationRoute:nonfile}/calendar"
@using BedBrigade.Common.Models
@using BedBrigade.Common.Enums
@using System.Diagnostics
@inject ILogger<UpcomingEvents> Logger
@using Syncfusion.Blazor.Schedule

<div class="calendar-container @(ShowCard ? "blurred" : "")">
    <div class="mobile-message">@_lc.Keys["TurnYourPhone"]</div>
    <SfSchedule CssClass="customize-schedule"
                TValue="AppointmentData"
                Width="100%" Height="700px"
                Readonly="true"
                CurrentView="View.Month"
                ShowHeaderBar="true"
                ShowQuickInfo="false"
                EnableAdaptiveUI="false"
                @bind-SelectedDate="@CurrentDate">
        <ScheduleEvents TValue="AppointmentData" OnEventClick="OnEventClick" ></ScheduleEvents>
        <ScheduleEventSettings DataSource="@dataSource"></ScheduleEventSettings>
        <ScheduleViews>
            <ScheduleView MaxEventsPerRow="6" Option="View.Month">
                <EventTemplate>
                    @{
                        AppointmentData? evt = (context as AppointmentData);
                        <EventView EventData="@evt" RequestedView="month" OnHyperlinkClicked="OnHyperlinkClicked" LocationRoute="@LocationRoute" />
                    }
                </EventTemplate>
            </ScheduleView>
        </ScheduleViews>
    </SfSchedule>
    <a href="@($"/{LocationRoute}/Events")" class="btn btn-primary mt-3 ms-3">@_lc["Events"]</a>
</div>

@if (ShowCard)
{
    <div class="bb-overlay">
        <div class="bb-card-wrapper">
            <div class="card shadow-lg">

                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        @_lc["BedBrigadeLocationEvents"]                                                                    
                    </h5>
                    <button type="button"
                            class="btn btn-link p-0 m-0 text-decoration-none fs-4 fw-bold text-secondary"
                            @onclick="() => ShowCard = false">
                        ×
                    </button>
                </div>

                <div class="card-body" >
                    @if (evt is not null)
                    {
                        <EventView EventData="@evt"
                                   RequestedView="quick"
                                   LocationRoute="@LocationRoute" />
                    }
                </div>

                <div class="card-footer text-center">
                    <button class="btn btn-primary btn-sm"
                    @onclick="() => ShowCard = false">
                        @_lc["Close"]
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code{

    private AppointmentData? evt { get; set; } = new AppointmentData();
    private bool _isHyperlinkClicked;
    private bool ShowCard = false;

    private void OnHyperlinkClicked()
    {
        Debug.WriteLine("Hyperlink clicked");
        _isHyperlinkClicked = true;
    }

    private void OnEventClick(EventClickArgs<AppointmentData> args)
    {
        args.Cancel = true;
        if (args.Event is AppointmentData appt)
        {
            evt = appt;
            ShowCard = true;
            StateHasChanged();
        }
    }
      
    private void DialogClose(Object args)
    {       
        _isHyperlinkClicked = false;
    }

}

<style>

    .e-schedule .template-wrap {
        height: 200px;
        white-space: normal;
    }

    .e-schedule .agenda-wrap {
        height: 300px;
        white-space: normal;
    }

    .e-schedule .e-month-view {
        height: 700px !important;
    }

    .e-schedule .e-month-view .e-work-cells {
        height: calc((700px - 100px) / 6) !important; /* Subtracting header height and dividing by typical number of weeks */
    }

    .e-schedule .e-month-view .e-appointment {
        height: auto !important;
        max-height: calc(((700px - 100px) / 6) - 10px) !important; /* Leaving some padding */
        font-size: smaller;
        padding-left: 5px;
        margin-left: 12px;
    }

    @@media (max-width: 767px) {
        .e-schedule .e-month-view .e-appointment
        {
            padding-left: 0px;
            margin-left: 0px;
        }
    }

    .content-area {
        padding: 10px;
        width: 100%;
    }

       .control-section {
        margin-top: 10px;
    }

    /* Hide the view selector buttons */
    .e-schedule .e-schedule-toolbar .e-views {
        display: none !important;
    }

    /* Ensure the navigation controls stay visible and centered */
    .e-schedule .e-schedule-toolbar .e-toolbar-items {
        justify-content: center;
    }

    /* Dim or blur background calendar when card open */
    .blurred {
        filter: blur(3px);
        opacity: 0.5;
        pointer-events: none; /* disables clicking while overlay open */
    }

    /* Overlay stays on top of blurred calendar */
    .bb-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.45);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        overflow-y: auto;
    }

    /* Wrapper ensures card width & centering */
    .bb-card-wrapper .card-body {
        width: 100%;
        max-width: 360px;
        margin: 0 1rem;
        flex: 1 1 auto; /* take remaining space */
        min-height: 0; /* CRITICAL for Chrome/Safari flex overflow */
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch; /* smooth iOS scrolling */
    }

    /* Optional: make sure header/footer text wraps nicely on mobile */
    .card-header h5 {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .card-footer {
        background-color: #f8f9fa;
    }

</style>