@layout Layout.NoHeaderFooterLayout
@page "/administration/edit/editcontent/{LocationId:int}/{ContentName}"
@using BlazorMonaco.Editor
@using ContentType = BedBrigade.Common.Enums.ContentType
<CheckAuth Roles=@RoleNames.CanManagePages></CheckAuth>

<style>
    .center-align td {
        vertical-align: middle;
    }
</style>

@if (Content == null && ImageButtonList == null)
{
    <Spinner />
}
else
{

    <div class="container-fluid px-3">

        <div class="d-flex align-items-center justify-content-between mb-1 mt-2">
            <h4 class="mb-0">@WorkTitle</h4>
        </div>
        @if (!ShowSourceBox)
        {
            <div class="row">
                @foreach (var item in ImageButtonList)
                {
                    <div class="col-12 col-md-2 d-flex align-items-center mb-1">
                        <div class="me-2">
                            @item.Key
                        </div>
                        <button type="button" class="btn" @onclick="(() => HandleImageButtonClick(item.Value))">
                            <img src="Media/national/photosIcon16x16.png"/>
                        </button>
                    </div>
                }
                <div class="col-12 col-md-2 d-flex align-items-center mb-1">
                    <input class="form-check-input me-2" type="checkbox" id="chkConvertImages"
                           @bind="ConvertImages" @bind:after="UpdateSaveUrl"/>
                    <label class="form-check-label" for="chkConvertImages">Convert Images</label>
                </div>
            </div>
        }
        <EditForm Model="Content">
            <DataAnnotationsValidator/>
            <div class="form-group mb-3">
                <label for="pageTitle">Page Title</label>
                <InputText id="pageTitle" class="form-control" @bind-Value="Content.Title"  />
                <ValidationMessage For="@(() => Content.Title)" />
            </div>

            @* only show when editing Stories or News *@
            @if (!ShowSourceBox 
                 && (Content?.ContentType == ContentType.Stories || Content?.ContentType == ContentType.News))
            {
                <div class="mb-3">
                    @if (!string.IsNullOrEmpty(Content.MainImageFileName))
                    {
                        <img src="@($"{ImagePath}/{Content.MainImageFileName}")"
                             class="img-thumbnail"
                             style="max-height:200px;"/>
                    }
                    <!-- Hidden native file input -->
                    <InputFile id="@_fileInputId"
                               @ref="_fileInput"
                               OnChange="OnInputFileChange"
                               accept="@String.Join(',', _allowedImageExtensions)"
                               style="display:none"/>

                    <!-- Label that looks like a button -->
                    <label class="btn btn-primary" for="@_fileInputId">
                        @FileButtonText
                    </label>
                </div>
            }
            @if (ShowSourceBox)
            {
                <div class="btn-group" role="group">
                    <button class="btn editor-btn" @onclick="PreviewFromSource">
                        <i class="fas fa-eye"></i> Preview
                    </button>
                    <button class="btn editor-btn" @onclick="OpenFind">
                        <i class="fas fa-search"></i> Find
                    </button>
                    <button class="btn editor-btn" @onclick="OpenFindReplace">
                        <i class="fas fa-search-plus"></i> Find &amp; Replace
                    </button>
                    <div class="form-check form-switch text-dark ms-3">
                        <input class="form-check-input"
                               type="checkbox"
                               id="darkModeSwitch"
                               @bind="IsDarkMode"/>
                        <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                    </div>
                </div>
            }
            <div class="rte-container">
                @* Show our own Source view *@
                @if (ShowSourceBox)
                {
                    <StandaloneCodeEditor @ref="_monaco"
                                          Id="bb-source-editor"
                                          CssClass="bb-source-editor"
                                          ConstructionOptions="EditorConstructionOptions"
                                          OnDidChangeModelContent="OnMonacoChanged"/>
                }
                else
                {
                    <SfRichTextEditor @ref="RteObj"
                                      EditorMode="EditorMode.HTML"
                                      Height="80vh"
                                      @bind-Value="Body"
                                      EnableHtmlSanitizer="true">

                        <RichTextEditorPasteCleanupSettings KeepFormat="true" PlainText="false"/>

                        <RichTextEditorImageSettings SaveUrl="@SaveUrl"
                                                     Path="@ImagePath"
                                                     AllowedTypes="@_allowedImageExtensions"/>

                        <RichTextEditorToolbarSettings Items="@Tools">
                            <RichTextEditorCustomToolbarItems>
                                <RichTextEditorCustomToolbarItem Name="bbSource">
                                    <Template>
                                        <!-- Render a toolbar-styled button with an icon -->
                                        <button type="button"
                                                class="e-tbar-btn e-control e-btn"
                                                @onclick="OpenSource">
                                            <span class="e-icons e-code-view" aria-hidden="true"></span>
                                            <span class="e-tbar-btn-text">Source</span>
                                        </button>
                                    </Template>
                                </RichTextEditorCustomToolbarItem>
                            </RichTextEditorCustomToolbarItems>
                        </RichTextEditorToolbarSettings>

                        <RichTextEditorEvents OnImageUploadSuccess="OnImageUploadSuccess"/>
                    </SfRichTextEditor>
                }

            </div>
            <div>
                <button id="save" type="button" class="btn btn-primary" @onclick="(() => HandleSaveOnlyClick())">Save Only</button>
                <button id="saveAndClose" type="button" class="btn btn-primary" @onclick="(() => HandleSaveAndCloseClick())">Save and Close</button>
                <button id="cancel" type="button" class="btn btn-secondary" @onclick="(() => HandleCancelClick())">Cancel</button>
            </div>
        </EditForm>
    </div>

    <SfDialog @ref="MediaDialog" Width="90%" IsModal="true" ShowCloseIcon="true" Visible="false" ZIndex="100000" >
        <DialogEvents OnOpen="onOpen"></DialogEvents>
        <DialogTemplates>
            <Header>Upload Files</Header>
            <Content>

                <MediaManager AllowedExtensions="@_allowedImageExtensions" 
                              EnableFolderOperations="@_enableFolderOperations" 
                              MaxFileSize="@_maxFileSize" 
                              RootFolder="@FolderPath"
                              MediaFolderName="@_mediaFolder"/>

            </Content>
        </DialogTemplates>
        <DialogButtons>
            <DialogButton Content="Close" IsPrimary="true" OnClick="@CloseDialog"/>
        </DialogButtons>
    </SfDialog>
}

<style>
    .bb-source-editor {
        height: 82vh;
    }

    .editor-btn {
        font-size: 0.8rem; /* smaller text */
        padding: 0.25rem 0.5rem; /* smaller height */
        border: 1px solid #dee2e6; /* lighter gray (Bootstrap gray-200) */
        box-shadow: 1px 1px 2px rgba(0,0,0,0.15); /* subtle shadow */
        line-height: 1.2; /* tighter vertical alignment */
    }
</style>